# تقرير السجلات اليتيمة (Orphaned Records Report)

**التاريخ:** 2026-01-21  
**القاعدة:** أي عملية أو فاتورة غير مرتبطة بقيد لا يجب أن يكون لها وجود في النظام

## النتائج

### ✅ الفلترة تعمل بشكل صحيح
- الواجهة الأمامية لا تعرض السجلات اليتيمة (بفضل الفلترة في endpoints)
- قاعدة البيانات تحتوي على سجلات يتيمة يجب معالجتها

### ⚠️ السجلات اليتيمة المكتشفة

#### 1. المصروفات (Expenses) - 4 سجلات
| ID | Invoice Number | Status | Total | Date | journal_entry_id |
|----|----------------|--------|-------|------|------------------|
| 11 | EXP-11 | posted | 42.30 | 2026-01-15 | NULL |
| 10 | EXP-10 | reversed | 42.30 | 2026-01-15 | NULL |
| 5 | EXP-5 | reversed | 185,253.23 | 2026-01-14 | NULL |
| 1 | EXP-1 | reversed | 230.25 | 2026-01-14 | NULL |

#### 2. فواتير المبيعات (Invoices) - 8 سجلات
| ID | Number | Status | Total | Date | journal_entry_id |
|----|--------|--------|-------|------|------------------|
| 12 | Auto | posted | 132.00 | 2026-01-21 | NULL |
| 7 | N/A | posted | 65.65 | 2026-01-20 | NULL |
| 6 | N/A | posted | 65.65 | 2026-01-20 | NULL |
| 5 | N/A | posted | 65.65 | 2026-01-20 | NULL |
| 4 | N/A | posted | 0.00 | 2026-01-20 | NULL |
| 3 | N/A | posted | 0.00 | 2026-01-20 | NULL |
| 2 | N/A | posted | 0.00 | 2026-01-20 | NULL |
| 1 | N/A | posted | 0.00 | 2026-01-20 | NULL |

#### 3. فواتير الموردين (Supplier Invoices) - 0 سجلات
✅ لا توجد سجلات يتيمة

#### 4. عمليات الرواتب (Payroll Runs) - 0 سجلات
✅ لا توجد سجلات يتيمة

## الإجراءات المطلوبة

### الخيار 1: حذف السجلات اليتيمة (موصى به)
- حذف جميع السجلات التي لها status = 'posted' أو 'reversed' بدون journal_entry_id
- هذا يضمن تطبيق القاعدة بشكل كامل

### الخيار 2: تغيير حالة السجلات إلى 'draft'
- تغيير status من 'posted'/'reversed' إلى 'draft' للسجلات اليتيمة
- يسمح بإعادة معالجتها لاحقاً

### الخيار 3: ربط السجلات بقيود موجودة
- البحث عن قيود موجودة يمكن ربطها بهذه السجلات
- تحديث journal_entry_id للسجلات

## التوصية

**الخيار 1 (الحذف)** هو الأفضل لأنه:
1. يطبق القاعدة بشكل كامل
2. يمنع أي التباس في البيانات
3. السجلات اليتيمة لا تظهر في الواجهة على أي حال

## السكريبتات المتاحة

1. `scripts/check_orphaned_records.js` - للفحص
2. `scripts/delete_orphaned_records.js` - للحذف (يجب إنشاؤه)
3. `scripts/fix_orphaned_records.js` - للإصلاح (يجب إنشاؤه)
