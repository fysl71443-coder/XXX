# ØªØ´Ø®ÙŠØµ Ù…Ø´ÙƒÙ„Ø© Ø¥ØµØ¯Ø§Ø± Ø§Ù„ÙØ§ØªÙˆØ±Ø© ğŸ”

## Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ù…Ø¨Ù„Øº Ø¹Ù†Ù‡Ø§:
1. âœ… Ø¥ØµØ¯Ø§Ø± Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙŠÙ†Ø¬Ø­
2. âŒ Ù„Ø§ ÙŠØªÙ… ØªÙØ±ÙŠØº Ø§Ù„Ù…Ø³ÙˆØ¯Ø©
3. âŒ Ù„Ø§ ÙŠØªÙ… ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ø¥Ù„Ù‰ Ù…ØªØ§Ø­
4. âŒ Ù„Ø§ ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ù„Ù„ÙØ§ØªÙˆØ±Ø©

## Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø© Ù„Ù„Ù…Ø´ÙƒÙ„Ø©:

### 1. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ
**Ø§Ù„ÙƒÙˆØ¯ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ:** `backend/server.js` Ø§Ù„Ø³Ø·ÙˆØ± 5920-5967

**Ø§Ù„Ø´Ø±ÙˆØ·:**
- ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚ÙŠØ¯ ÙÙ‚Ø· Ø¥Ø°Ø§ `total > 0`
- ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† `journalEntryId` - Ø¥Ø°Ø§ ÙƒØ§Ù† `null` ÙŠØªÙ… ROLLBACK

**Ø§Ù„ØªØ­Ù‚Ù‚:**
- âœ… `total` ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† > 0
- âœ… `createInvoiceJournalEntry` ÙŠØ¬Ø¨ Ø£Ù† ØªØ±Ø¬Ø¹ `entryId` ÙˆÙ„ÙŠØ³ `null`

### 2. Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø·Ù„Ø¨ ÙˆØªÙØ±ÙŠØº Ø§Ù„Ù…Ø³ÙˆØ¯Ø©
**Ø§Ù„ÙƒÙˆØ¯ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ:** `backend/server.js` Ø§Ù„Ø³Ø·ÙˆØ± 5969-6050

**Ø§Ù„Ø´Ø±ÙˆØ·:**
- ÙŠØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ° ÙÙ‚Ø· Ø¥Ø°Ø§ `order_id` Ù…ÙˆØ¬ÙˆØ¯
- ÙŠØªÙ… Ø¨Ø¹Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­

**Ø§Ù„ØªØ­Ù‚Ù‚:**
- âœ… `order_id` ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ ÙˆÙ…Ø±Ø³Ù„Ø§Ù‹ ÙÙŠ `req.body`
- âœ… `orderTableCode` Ùˆ `orderBranch` ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ†Ø§ Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ† Ù…Ù† query Ø§Ù„Ø·Ù„Ø¨

### 3. ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø§ÙˆÙ„Ø©
**Ø§Ù„ÙƒÙˆØ¯ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ:** `backend/server.js` Ø§Ù„Ø³Ø·ÙˆØ± 6009-6049

**Ø§Ù„Ø´Ø±ÙˆØ·:**
- ÙŠØªÙ… ÙÙ‚Ø· Ø¥Ø°Ø§ `orderTableCode && orderBranch` Ù…ÙˆØ¬ÙˆØ¯Ø§Ù†
- ÙŠØ­Ø§ÙˆÙ„ Ø¹Ø¯Ø© Ø¨Ù†Ù‰ Ø¬Ø¯ÙˆÙ„ (`pos_tables`, `tables`)

**Ø§Ù„ØªØ­Ù‚Ù‚:**
- âœ… Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ø§ÙˆÙ„Ø§Øª Ù…ÙˆØ¬ÙˆØ¯ ÙˆÙ„Ù‡ Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„ØµØ­ÙŠØ­Ø©
- âœ… Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© (`status`, `current_order_id`, `branch`, `table_code`)

## Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ´Ø®ÙŠØµ:

### 1. ÙØ­Øµ Logs
```bash
# Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†:
- "[POS] Starting journal entry creation"
- "[POS] Total > 0, proceeding with journal entry creation"
- "[POS] âœ… Linked journal entry"
- "[POS] Starting order/table cleanup"
- "[POS] âœ… Order X â†’ CLOSED"
- "[POS] âœ… Updated pos_tables"
```

### 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† order_id
```sql
SELECT id, status, invoice_id, table_code, branch 
FROM orders 
WHERE id = <order_id>;
```

### 3. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‚ÙŠÙˆØ¯
```sql
SELECT je.id, je.entry_number, je.description, je.status, je.reference_id
FROM journal_entries je
WHERE je.reference_type = 'invoice' 
  AND je.reference_id = <invoice_id>;
```

### 4. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø§ÙˆÙ„Ø©
```sql
SELECT * FROM pos_tables WHERE branch = '<branch>' AND table_code = '<table_code>';
-- Ø£Ùˆ
SELECT * FROM tables WHERE branch = '<branch>' AND code = '<table_code>';
```

## Ø§Ù„Ø­Ù„ÙˆÙ„ Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø©:

### Ø§Ù„Ø­Ù„ 1: Ø¥Ø¶Ø§ÙØ© logging Ø´Ø§Ù…Ù„
âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© logging ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø­Ø±Ø¬Ø©

### Ø§Ù„Ø­Ù„ 2: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† order_id
- ØªØ£ÙƒØ¯ Ø£Ù† `b.order_id` Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ `req.body`
- ØªØ£ÙƒØ¯ Ø£Ù† `order_id` ÙŠØªÙ… ØªÙ…Ø±ÙŠØ±Ù‡ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­

### Ø§Ù„Ø­Ù„ 3: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† total
- ØªØ£ÙƒØ¯ Ø£Ù† `total > 0`
- ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù‚ÙŠÙ… Ù…Ø­Ø³ÙˆØ¨Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­

### Ø§Ù„Ø­Ù„ 4: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ø§ÙˆÙ„Ø§Øª
- ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¬Ø¯ÙˆÙ„ `pos_tables` Ø£Ùˆ `tables`
- ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©

## Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ØµØ­ÙŠØ­ (Ø§Ù„Ù…ÙØ±ÙˆØ¶):

```javascript
// 1. INSERT invoice âœ…
// 2. CREATE journal entry (if total > 0) âœ…
// 3. CLOSE order (if order_id exists) âœ…
// 4. DELETE draft (if order_id exists) âœ…
// 5. UPDATE table (if order_id and table_code exist) âœ…
// 6. COMMIT âœ…
```

## Ù…Ù„Ø§Ø­Ø¸Ø§Øª:
- Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø¯Ø§Ø®Ù„ transaction ÙˆØ§Ø­Ø¯Ø©
- Ø¥Ø°Ø§ ÙØ´Ù„ Ø£ÙŠ Ø®Ø·ÙˆØ©ØŒ ÙŠØªÙ… ROLLBACK
- Logging Ø´Ø§Ù…Ù„ ØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡ Ù„ØªØªØ¨Ø¹ Ø§Ù„ØªÙ†ÙÙŠØ°
