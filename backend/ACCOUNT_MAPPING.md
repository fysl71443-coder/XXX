# Account Mapping - ربط الحسابات بالنظام

## الحسابات الرئيسية (Account Numbers)

### الأصول (Assets) - 0001
- **1111**: صندوق رئيسي (Main Cash) - يستخدم في المبيعات النقدية
- **1112**: صندوق فرعي (Sub Cash)
- **1121**: بنك الراجحي (Al Rajhi Bank)
- **1122**: بنك الأهلي (Al Ahli Bank)
- **1123**: بنك الرياض (Riyad Bank)
- **1141**: عملاء (Customers) - حساب رئيسي للعملاء
- **1161**: مخزون بضائع (Merchandise Inventory)
- **1162**: مخزون مواد (Materials Inventory)

### الالتزامات (Liabilities) - 0002
- **2111**: موردون (Suppliers) - حساب رئيسي للموردين
- **2141**: ضريبة القيمة المضافة – مستحقة (VAT Output)

### الإيرادات (Revenue) - 0004
- **4100**: الإيرادات التشغيلية حسب الفرع
- **4111**: مبيعات نقدية – China Town (Cash Sales - China Town)
- **4112**: مبيعات آجلة – China Town (Credit Sales - China Town)
- **4121**: مبيعات نقدية – Place India (Cash Sales - Place India)
- **4122**: مبيعات آجلة – Place India (Credit Sales - Place India)

### المصروفات (Expenses) - 0005
- **5100**: مصروفات تشغيلية (Operating Expenses)
- **5110**: تكلفة مبيعات (Cost of Sales)
- **5120**: مصروف كهرباء (Electricity Expense)
- **5130**: مصروف ماء (Water Expense)
- **5140**: مصروف اتصالات (Telecom Expense)
- **5200**: مصروفات إدارية وعمومية (Administrative Expenses)
- **5210**: رواتب وأجور (Salaries and Wages)
- **5220**: بدلات (Allowances)

## الربط في النظام (System Integration)

### 1. نقطة البيع (POS) - `/pos/issue` أو `/invoices`
**المبيعات النقدية:**
- مدين: `1111` (صندوق رئيسي)
- دائن: `4111` (مبيعات نقدية – China Town) أو `4121` (Place India)
- دائن: `2141` (VAT Output) - إذا كان هناك ضريبة

**المبيعات الآجلة:**
- مدين: حساب فرعي تحت `1141` (العميل)
- دائن: `4112` (مبيعات آجلة – China Town) أو `4122` (Place India)
- دائن: `2141` (VAT Output) - إذا كان هناك ضريبة

**الكود:** `handleIssueInvoice()` في `server.js` - السطر ~2780

### 2. العملاء (Customers) - `/partners?type=customer`
- كل عميل جديد يحصل على حساب فرعي تحت `1141` (عملاء)
- يتم إنشاؤه تلقائياً عند إنشاء عميل جديد
- **الكود:** `getOrCreatePartnerAccount()` - السطر ~2758

### 3. الموردون (Suppliers) - `/partners?type=supplier`
- كل مورد جديد يحصل على حساب فرعي تحت `2111` (موردون)
- يتم إنشاؤه تلقائياً عند إنشاء مورد جديد
- **الكود:** `getOrCreatePartnerAccount()` - السطر ~2758

### 4. المصروفات (Expenses) - `/expenses`
- **المطلوب:** ربط المصروفات بالحسابات الصحيحة حسب النوع:
  - كهرباء → `5120`
  - ماء → `5130`
  - اتصالات → `5140`
  - رواتب → `5210`
  - بدلات → `5220`
- **الحالة:** يحتاج تطبيق

### 5. المشتريات (Purchases) - `/supplier-invoices`
- **المطلوب:** ربط المشتريات بحسابات المخزون والموردين:
  - مدين: `1161` (مخزون بضائع) أو `1162` (مخزون مواد)
  - دائن: حساب فرعي تحت `2111` (المورد)
  - مدين: `1170` (VAT Input) - إذا كان هناك ضريبة مدخلات
- **الحالة:** يحتاج تطبيق

### 6. تكلفة البضاعة المباعة (COGS) - عند إصدار الفاتورة
- **المطلوب:** عند بيع المنتج، يجب تسجيل:
  - مدين: `5110` (تكلفة مبيعات)
  - دائن: `1161` (مخزون بضائع)
- **الحالة:** يحتاج تطبيق

## الوظائف المساعدة (Helper Functions)

### `getAccountIdByNumber(accountNumber)`
- البحث عن حساب بواسطة رقم الحساب
- **الموقع:** `server.js` - السطر ~2744

### `getOrCreatePartnerAccount(partnerId, partnerType)`
- إنشاء حساب فرعي للعميل/المورد تلقائياً
- **الموقع:** `server.js` - السطر ~2758

### `createInvoiceJournalEntry(invoiceId, invoiceData)`
- إنشاء قيد محاسبي تلقائي عند إصدار فاتورة
- **الموقع:** `server.js` - السطر ~2780

## الاختبار

### للتأكد من الربط:
1. **إصدار فاتورة POS نقدية:**
   - تحقق من وجود قيد في `journal_entries`
   - تحقق من وجود posting للصندوق (`1111`) والإيرادات (`4111`)

2. **إنشاء عميل جديد:**
   - تحقق من وجود حساب فرعي تحت `1141`

3. **إنشاء مورد جديد:**
   - تحقق من وجود حساب فرعي تحت `2111`

## ملاحظات
- جميع الحسابات الرئيسية موجودة في `seed_accounts_and_products.cjs`
- الكود الحالي يربط المبيعات بشكل صحيح
- المصروفات والمشتريات تحتاج تطبيق الربط
