<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title id="pageTitle">قائمة الدخل</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root { --border:#222; --soft:#eaeaea; --muted:#555; }
  @page { margin: 18mm 15mm; }
  body { font-family: 'Cairo', sans-serif; margin: 0; }
  body.rtl { direction: rtl; }
  body.ltr { direction: ltr; }
  .header { display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid var(--border); padding-bottom:8px; margin-bottom:10px; }
  .brand { display:flex; align-items:center; gap:12px; }
  .brand img { height:48px; max-width:180px; object-fit:contain; display:none; }
  .brand .name { font-weight:700; }
  .brand .vat { color:var(--muted); font-size:13px; }
  .doc .title { font-size:18px; font-weight:700; }
  .doc .meta { color:var(--muted); font-size:13px; }
  table { width: 100%; border-collapse: collapse; margin-top: 12px; }
  thead th { background: #f2f2f2; }
  th, td { border: 1px solid #000; padding: 6px; font-size: 13px; }
  body.rtl th, body.rtl td { text-align: right; }
  body.ltr th, body.ltr td { text-align: left; }
  tbody tr:nth-child(even){ background:#fafafa }
  .summary { margin-top: 12px; font-weight: 600; padding: 10px; background: #f5f5f5; border-radius: 4px; }
  .summary.positive { color: #16a34a; }
  .summary.negative { color: #dc2626; }
  h2 { font-size: 16px; margin: 20px 0 10px; color: #333; }
  @media print { .no-print { display: none; } }
</style>
</head>
<body class="rtl">
<div class="no-print" style="margin-bottom:8px; display:flex; gap:8px; align-items:center;">
  <button onclick="prepareAndPrint()" style="padding:6px 10px;" id="btnPrint">طباعة</button>
  <button onclick="window.close()" style="padding:6px 10px;" id="btnClose">إغلاق</button>
  <select id="langSelect" onchange="changeLang(this.value)" style="padding:6px 10px;">
    <option value="ar">العربية</option>
    <option value="en">English</option>
  </select>
</div>
<div class="header">
  <div class="brand">
    <img id="logo" alt="" />
    <div>
      <div class="name" id="companyName"></div>
      <div class="vat" id="companyVat"></div>
    </div>
  </div>
  <div class="doc">
    <div class="title" id="reportTitle">قائمة الدخل</div>
    <div class="meta" id="meta"></div>
  </div>
</div>
<h2 id="titleRevenues">الإيرادات</h2>
<table id="revenues">
  <thead>
    <tr><th id="thItem1">البند</th><th id="thAmount1">المبلغ</th></tr>
  </thead>
  <tbody></tbody>
  <tfoot>
    <tr style="background:#e8f5e9;font-weight:600;">
      <td id="totalRevenuesLabel">إجمالي الإيرادات</td>
      <td id="totalRevenues">0.00</td>
    </tr>
  </tfoot>
</table>
<h2 id="titleExpenses">المصروفات</h2>
<table id="expenses">
  <thead>
    <tr><th id="thItem2">البند</th><th id="thAmount2">المبلغ</th></tr>
  </thead>
  <tbody></tbody>
  <tfoot>
    <tr style="background:#ffebee;font-weight:600;">
      <td id="totalExpensesLabel">إجمالي المصروفات</td>
      <td id="totalExpenses">0.00</td>
    </tr>
  </tfoot>
</table>
<div class="summary" id="net"></div>
<script>
  const labels = {
    ar: {
      pageTitle: 'قائمة الدخل',
      reportTitle: 'قائمة الدخل',
      btnPrint: 'طباعة',
      btnClose: 'إغلاق',
      titleRevenues: 'الإيرادات',
      titleExpenses: 'المصروفات',
      thItem: 'البند',
      thAmount: 'المبلغ',
      totalRevenues: 'إجمالي الإيرادات',
      totalExpenses: 'إجمالي المصروفات',
      netIncome: 'صافي الدخل',
      netLoss: 'صافي الخسارة',
      from: 'من',
      to: 'إلى',
      vatNumber: 'الرقم الضريبي'
    },
    en: {
      pageTitle: 'Income Statement',
      reportTitle: 'Income Statement',
      btnPrint: 'Print',
      btnClose: 'Close',
      titleRevenues: 'Revenues',
      titleExpenses: 'Expenses',
      thItem: 'Item',
      thAmount: 'Amount',
      totalRevenues: 'Total Revenues',
      totalExpenses: 'Total Expenses',
      netIncome: 'Net Income',
      netLoss: 'Net Loss',
      from: 'From',
      to: 'To',
      vatNumber: 'VAT Number'
    }
  };
  
  let currentLang = localStorage.getItem('lang') || 'ar';
  let loadedData = { revenues: [], expenses: [], company: null, branding: null, from: null, to: null };
  
  function changeLang(lang) {
    currentLang = lang;
    const l = labels[lang] || labels.ar;
    document.documentElement.lang = lang;
    document.body.className = lang === 'ar' ? 'rtl' : 'ltr';
    document.getElementById('pageTitle').textContent = l.pageTitle;
    document.getElementById('reportTitle').textContent = l.reportTitle;
    document.getElementById('btnPrint').textContent = l.btnPrint;
    document.getElementById('btnClose').textContent = l.btnClose;
    document.getElementById('titleRevenues').textContent = l.titleRevenues;
    document.getElementById('titleExpenses').textContent = l.titleExpenses;
    document.getElementById('thItem1').textContent = l.thItem;
    document.getElementById('thAmount1').textContent = l.thAmount;
    document.getElementById('thItem2').textContent = l.thItem;
    document.getElementById('thAmount2').textContent = l.thAmount;
    document.getElementById('totalRevenuesLabel').textContent = l.totalRevenues;
    document.getElementById('totalExpensesLabel').textContent = l.totalExpenses;
    document.getElementById('langSelect').value = lang;
    
    // Re-render period label
    const meta = [];
    if (loadedData.from) meta.push(`${l.from}: ${loadedData.from}`);
    if (loadedData.to) meta.push(`${l.to}: ${loadedData.to}`);
    document.getElementById('meta').textContent = meta.join(' • ');
    
    // Re-render company info
    if (loadedData.company) {
      const name = lang === 'ar' ? (loadedData.company.name_ar || loadedData.company.name_en || '') : (loadedData.company.name_en || loadedData.company.name_ar || '');
      const vat = loadedData.company.vat_number ? `${l.vatNumber}: ${loadedData.company.vat_number}` : '';
      document.getElementById('companyName').textContent = name;
      document.getElementById('companyVat').textContent = vat;
    }
    
    renderTables();
  }
  
  function renderTables() {
    const l = labels[currentLang] || labels.ar;
    
    // Revenues
    const tbodyR = document.querySelector('#revenues tbody');
    tbodyR.innerHTML = '';
    let totalRev = 0;
    loadedData.revenues.filter(r => Math.abs(Number(r.amount || r.total || 0)) > 1e-9).forEach(r => {
      const tr = document.createElement('tr');
      const name = currentLang === 'ar' ? (r.name || r.name_ar || '') : (r.name_en || r.name || '');
      const amount = Number(r.amount || r.total || 0);
      [name, fmt(amount)].forEach(v => {
        const td = document.createElement('td');
        td.textContent = String(v);
        tr.appendChild(td);
      });
      tbodyR.appendChild(tr);
      totalRev += amount;
    });
    document.getElementById('totalRevenues').textContent = fmt(totalRev);
    
    // Expenses
    const tbodyE = document.querySelector('#expenses tbody');
    tbodyE.innerHTML = '';
    let totalExp = 0;
    loadedData.expenses.filter(r => Math.abs(Number(r.amount || r.total || 0)) > 1e-9).forEach(r => {
      const tr = document.createElement('tr');
      const name = currentLang === 'ar' ? (r.name || r.name_ar || '') : (r.name_en || r.name || '');
      const amount = Number(r.amount || r.total || 0);
      [name, fmt(amount)].forEach(v => {
        const td = document.createElement('td');
        td.textContent = String(v);
        tr.appendChild(td);
      });
      tbodyE.appendChild(tr);
      totalExp += amount;
    });
    document.getElementById('totalExpenses').textContent = fmt(totalExp);
    
    // Net income
    const net = totalRev - totalExp;
    const netEl = document.getElementById('net');
    netEl.textContent = `${net >= 0 ? l.netIncome : l.netLoss}: ${fmt(Math.abs(net))}`;
    netEl.className = `summary ${net >= 0 ? 'positive' : 'negative'}`;
  }
  
  function getApiBase() {
    if (window.__API__) return window.__API__;
    const port = window.location.port;
    if (port === '4000' || port === '3000') return 'http://localhost:5000/api';
    return window.location.origin + '/api';
  }
  const API_BASE = getApiBase();
  function qp(k) { return new URLSearchParams(location.search).get(k); }
  function fmt(n) { try { return Number(n || 0).toFixed(2); } catch { return '0.00'; } }
  function prepareAndPrint() { const bar = document.querySelector('.no-print'); if (bar) bar.style.display = 'none'; window.print(); }
  
  async function authFetch(url) {
    const token = localStorage.getItem('token');
    const h = token ? { Authorization: `Bearer ${token}` } : {};
    const r = await fetch(url, { headers: h });
    if (!r.ok) throw new Error('request_failed');
    return r.json();
  }
  
  async function load() {
    document.getElementById('langSelect').value = currentLang;
    if (currentLang === 'en') {
      document.documentElement.lang = 'en';
      document.body.className = 'ltr';
    }
    
    try { loadedData.company = await authFetch(`${API_BASE}/settings/settings_company`); } catch {}
    try { loadedData.branding = await authFetch(`${API_BASE}/settings/settings_branding`); } catch {}
    
    if (loadedData.branding && loadedData.branding.logo) {
      const img = document.getElementById('logo');
      img.src = loadedData.branding.logo;
      img.style.display = 'block';
    }
    
    loadedData.from = qp('from');
    loadedData.to = qp('to');
    
    const params = new URLSearchParams();
    if (loadedData.from) params.set('from', loadedData.from);
    if (loadedData.to) params.set('to', loadedData.to);
    
    const res = await authFetch(`${API_BASE}/reports/income-statement${params.toString() ? `?${params.toString()}` : ''}`);
    loadedData.revenues = Array.isArray(res.revenues) ? res.revenues : [];
    loadedData.expenses = Array.isArray(res.expenses) ? res.expenses : [];
    
    // Fetch account names
    try {
      const accountsTree = await authFetch(`${API_BASE}/accounts`);
      const accountMap = new Map();
      function flattenAccounts(arr) {
        if (!Array.isArray(arr)) return;
        for (const a of arr) {
          if (a && a.id) {
            if (a.account_code) accountMap.set(String(a.account_code), a);
            if (a.account_number) accountMap.set(String(a.account_number), a);
            if (Array.isArray(a.children)) flattenAccounts(a.children);
          }
        }
      }
      flattenAccounts(accountsTree);
      
      // Enrich revenues with names
      for (const r of loadedData.revenues) {
        const code = String(r.code || '').trim();
        const acc = accountMap.get(code);
        if (acc) {
          r.name = r.name || acc.name || '';
          r.name_en = r.name_en || acc.name_en || '';
          r.name_ar = r.name_ar || acc.name || '';
        }
      }
      
      // Enrich expenses with names
      for (const e of loadedData.expenses) {
        const code = String(e.code || '').trim();
        const acc = accountMap.get(code);
        if (acc) {
          e.name = e.name || acc.name || '';
          e.name_en = e.name_en || acc.name_en || '';
          e.name_ar = e.name_ar || acc.name || '';
        }
      }
    } catch (e) {
      console.warn('Failed to fetch account names:', e);
    }
    
    changeLang(currentLang);
    setTimeout(() => window.print(), 200);
  }
  
  load().catch((err) => {
    console.error('Load error:', err);
    alert('فشل الطباعة. يرجى المحاولة مرة أخرى.');
  });
</script>
</body>
</html>
