<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>تقرير اليوم التشغيلي</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root { --border:#222; --muted:#555; }
  @page { margin: 18mm 15mm; }
  body { font-family: 'Cairo', sans-serif; direction: rtl; margin: 0; }
  .header { display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid var(--border); padding-bottom:8px; margin-bottom:10px; }
  .brand { display:flex; align-items:center; gap:12px; }
  .brand img { height:48px; max-width:180px; object-fit:contain; display:none; }
  .brand .name { font-weight:700; }
  .brand .vat { color:var(--muted); font-size:13px; }
  .doc .title { font-size:18px; font-weight:700; }
  .doc .meta { color:var(--muted); font-size:13px; text-align:left; }
  table { width: 100%; border-collapse: collapse; margin-top: 12px; }
  thead th { background: #f2f2f2; }
  th, td { border: 1px solid #000; padding: 6px; text-align: right; font-size: 13px; }
  tbody tr:nth-child(even){ background:#fafafa }
  .summary { margin-top: 12px; font-weight: 600; }
  @media print { .no-print { display: none; } }
</style>
</head>
<body>
<div class="no-print" style="margin-bottom:8px; display:flex; gap:8px; align-items:center;">
  <button onclick="prepareAndPrint()" style="padding:6px 10px;">طباعة</button>
  <button onclick="window.close()" style="padding:6px 10px;">إغلاق</button>
</div>
<div class="header">
  <div class="brand">
    <img id="logo" alt="" />
    <div>
      <div class="name" id="companyName"></div>
      <div class="vat" id="companyVat"></div>
    </div>
  </div>
  <div class="doc">
    <div class="title">تقرير اليوم التشغيلي</div>
    <div class="meta" id="meta"></div>
  </div>
  </div>
<h2>ملخص الفروع</h2>
<table id="summary">
  <thead>
    <tr>
      <th>الفرع</th>
      <th>المبيعات</th>
      <th>الضريبة</th>
      <th>الخصم</th>
      <th>الفواتير</th>
      <th>نقدًا</th>
      <th>بطاقة</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
<h2>فواتير China Town</h2>
<table id="china">
  <thead>
    <tr>
      <th>الفاتورة</th>
      <th>الإيراد</th>
      <th>الضريبة</th>
      <th>الخصم</th>
      <th>الإجمالي</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
<h2>فواتير Place India</h2>
<table id="india">
  <thead>
    <tr>
      <th>الفاتورة</th>
      <th>الإيراد</th>
      <th>الضريبة</th>
      <th>الخصم</th>
      <th>الإجمالي</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
<script>
  const API_BASE = (window.__API__||'http://localhost:4000/api')
  function qp(k){ return new URLSearchParams(location.search).get(k) }
  function fmt(n){ try { return Number(n||0).toFixed(2) } catch { return '0.00' } }
  function prepareAndPrint(){ const bar=document.querySelector('.no-print'); if(bar) bar.style.display='none'; window.print() }
  async function authFetch(url){ const token = localStorage.getItem('token'); const h = token? { Authorization: `Bearer ${token}` } : {}; const r = await fetch(url, { headers: h }); if(!r.ok) throw new Error('request_failed'); return r.json() }
  async function load(){
    let company = null
    let branding = null
    try { company = await authFetch(`${API_BASE}/settings/settings_company`) } catch {}
    try { branding = await authFetch(`${API_BASE}/settings/settings_branding`) } catch {}
    if (company) { const name = company.name_ar || company.name_en || ''; const vat = company.vat_number ? `الرقم الضريبي: ${company.vat_number}` : ''; document.getElementById('companyName').textContent = name; document.getElementById('companyVat').textContent = vat }
    if (branding && branding.logo) { const img=document.getElementById('logo'); img.src=branding.logo; img.style.display='block' }
    const date = qp('date') || new Date().toISOString().slice(0,10)
    document.getElementById('meta').textContent = `التاريخ: ${date}`
    const china = await authFetch(`${API_BASE}/reports/business-day-sales?branch=china_town&date=${encodeURIComponent(date)}`)
    const india = await authFetch(`${API_BASE}/reports/business-day-sales?branch=place_india&date=${encodeURIComponent(date)}`)
    const tbodyS = document.querySelector('#summary tbody')
    tbodyS.innerHTML = ''
    const sC = china.summary||{}
    const sI = india.summary||{}
    const totalRow = (c,i)=>({ sales: (Number(c.total_sales||0)+Number(i.total_sales||0)), tax: (Number(c.total_tax||0)+Number(i.total_tax||0)), disc: (Number(c.total_discount||0)+Number(i.total_discount||0)), invs: (Number(c.invoices_count||0)+Number(i.invoices_count||0)), cash: (Number(c.cash_total||0)+Number(i.cash_total||0)), bank: (Number(c.bank_total||0)+Number(i.bank_total||0)) })
    const grand = totalRow(sC, sI)
    ;[
      ['china_town', sC],
      ['place_india', sI],
      ['الإجمالي', grand]
    ].forEach(([name, s])=>{
      const tr=document.createElement('tr')
      const vals = name==='الإجمالي' ? [name, fmt(s.sales), fmt(s.tax), fmt(s.disc), String(s.invs||0), fmt(s.cash), fmt(s.bank)] : [name, fmt(s.total_sales||0), fmt(s.total_tax||0), fmt(s.total_discount||0), String(s.invoices_count||0), fmt(s.cash_total||0), fmt(s.bank_total||0)]
      vals.forEach(v=>{ const td=document.createElement('td'); td.textContent=String(v); tr.appendChild(td) })
      tbodyS.appendChild(tr)
    })
    const fillInv = (tblId, items)=>{
      const tbody=document.querySelector(`#${tblId} tbody`); tbody.innerHTML=''
      const list = Array.isArray(items)?items:items?.invoices||items?.items||[]
      list.filter(r => Number((r.revenue_amount!=null?r.revenue_amount:r.amount)||0) > 0).forEach(r=>{
        const total = (r.total_sales!=null?r.total_sales:((r.revenue_amount!=null?r.revenue_amount:r.amount)||0)+(r.vat_amount||0))
        const tr=document.createElement('tr')
        ;[String(r.invoice_number||''), fmt((r.revenue_amount!=null?r.revenue_amount:r.amount)||0), fmt(r.vat_amount||0), fmt(r.discount_amount||0), fmt(total||0)].forEach(v=>{ const td=document.createElement('td'); td.textContent=String(v); tr.appendChild(td) })
        tbody.appendChild(tr)
      })
    }
    fillInv('china', china)
    fillInv('india', india)
    setTimeout(()=>window.print(), 200)
  }
  load().catch(()=>{ alert('فشل الطباعة. يرجى المحاولة مرة أخرى.') })
</script>
</body>
</html>