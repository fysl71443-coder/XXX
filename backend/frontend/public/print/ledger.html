<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title id="pageTitle">دفتر الأستاذ</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root { --border:#222; --soft:#eaeaea; --muted:#555; }
  @page { margin: 18mm 15mm; }
  body { font-family: 'Cairo', sans-serif; margin: 0; }
  body.rtl { direction: rtl; }
  body.ltr { direction: ltr; }
  .header { display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid var(--border); padding-bottom:8px; margin-bottom:10px; }
  .brand { display:flex; align-items:center; gap:12px; }
  .brand img { height:48px; max-width:180px; object-fit:contain; display:none; }
  .brand .name { font-weight:700; }
  .brand .vat { color:var(--muted); font-size:13px; }
  .doc .title { font-size:18px; font-weight:700; }
  .doc .meta { color:var(--muted); font-size:13px; }
  table { width: 100%; border-collapse: collapse; margin-top: 12px; }
  thead th { background: #f2f2f2; }
  th, td { border: 1px solid #000; padding: 6px; font-size: 12px; }
  body.rtl th, body.rtl td { text-align: right; }
  body.ltr th, body.ltr td { text-align: left; }
  tbody tr:nth-child(even){ background:#fafafa }
  .debit { color: #0d9488; font-weight: 600; }
  .credit { color: #dc2626; font-weight: 600; }
  .balance { font-weight: 700; }
  @media print { .no-print { display: none; } }
</style>
</head>
<body class="rtl">
<div class="no-print" style="margin-bottom:8px; display:flex; gap:8px; align-items:center;">
  <button onclick="prepareAndPrint()" style="padding:6px 10px;" id="btnPrint">طباعة</button>
  <button onclick="window.close()" style="padding:6px 10px;" id="btnClose">إغلاق</button>
  <select id="langSelect" onchange="changeLang(this.value)" style="padding:6px 10px;">
    <option value="ar">العربية</option>
    <option value="en">English</option>
  </select>
</div>
<div class="header">
  <div class="brand">
    <img id="logo" alt="" />
    <div>
      <div class="name" id="companyName"></div>
      <div class="vat" id="companyVat"></div>
    </div>
  </div>
  <div class="doc">
    <div class="title" id="reportTitle">دفتر الأستاذ</div>
    <div class="meta" id="meta"></div>
  </div>
</div>
<table id="tbl">
  <thead>
    <tr>
      <th id="thCode">الكود</th>
      <th id="thAccount">الحساب</th>
      <th id="thOpening">الرصيد الابتدائي</th>
      <th id="thEntry">القيد</th>
      <th id="thDebit">مدين</th>
      <th id="thCredit">دائن</th>
      <th id="thBalance">الرصيد الحالي</th>
      <th id="thNotes">ملاحظات</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
<script>
  const labels = {
    ar: {
      pageTitle: 'دفتر الأستاذ',
      reportTitle: 'دفتر الأستاذ',
      btnPrint: 'طباعة',
      btnClose: 'إغلاق',
      thCode: 'الكود',
      thAccount: 'الحساب',
      thOpening: 'الرصيد الابتدائي',
      thEntry: 'القيد',
      thDebit: 'مدين',
      thCredit: 'دائن',
      thBalance: 'الرصيد الحالي',
      thNotes: 'ملاحظات',
      from: 'من',
      to: 'إلى',
      vatNumber: 'الرقم الضريبي',
      noData: 'لا توجد حركات منشورة للفترة المحددة',
      // Note labels
      saleInvoice: 'فاتورة بيع',
      purchaseInvoice: 'فاتورة مشتريات',
      expense: 'مصروف',
      paymentCollection: 'سداد/تحصيل',
      payroll: 'مسير رواتب',
      cashReceipt: 'استلام نقدي من العميل',
      salesRevenue: 'إيرادات البيع',
      salesDiscount: 'خصم على المبيعات',
      salesTax: 'ضريبة مبيعات',
      salaryPayment: 'سداد الرواتب',
      cashFromCustomers: 'نقدية من العملاء',
      collection: 'تحصيل/سداد',
      salaryExpense: 'مصروف الرواتب',
      payrollLiability: 'التزام مستحق للرواتب',
      purchaseTax: 'ضريبة شراء مستحقة',
      supplierLiability: 'التزام الموردين'
    },
    en: {
      pageTitle: 'General Ledger',
      reportTitle: 'General Ledger',
      btnPrint: 'Print',
      btnClose: 'Close',
      thCode: 'Code',
      thAccount: 'Account',
      thOpening: 'Opening Balance',
      thEntry: 'Entry',
      thDebit: 'Debit',
      thCredit: 'Credit',
      thBalance: 'Current Balance',
      thNotes: 'Notes',
      from: 'From',
      to: 'To',
      vatNumber: 'VAT Number',
      noData: 'No posted entries for the selected period',
      // Note labels
      saleInvoice: 'Sale Invoice',
      purchaseInvoice: 'Purchase Invoice',
      expense: 'Expense',
      paymentCollection: 'Payment/Collection',
      payroll: 'Payroll Run',
      cashReceipt: 'Cash Receipt from Customer',
      salesRevenue: 'Sales Revenue',
      salesDiscount: 'Sales Discount',
      salesTax: 'Sales Tax',
      salaryPayment: 'Salary Payment',
      cashFromCustomers: 'Cash from Customers',
      collection: 'Collection/Payment',
      salaryExpense: 'Salary Expense',
      payrollLiability: 'Accrued Payroll Liability',
      purchaseTax: 'Input VAT',
      supplierLiability: 'Suppliers Liability'
    }
  };
  
  let currentLang = localStorage.getItem('lang') || 'ar';
  let loadedData = { accounts: [], company: null, branding: null, from: null, to: null };
  
  function changeLang(lang) {
    currentLang = lang;
    const l = labels[lang] || labels.ar;
    document.documentElement.lang = lang;
    document.body.className = lang === 'ar' ? 'rtl' : 'ltr';
    document.getElementById('pageTitle').textContent = l.pageTitle;
    document.getElementById('reportTitle').textContent = l.reportTitle;
    document.getElementById('btnPrint').textContent = l.btnPrint;
    document.getElementById('btnClose').textContent = l.btnClose;
    document.getElementById('thCode').textContent = l.thCode;
    document.getElementById('thAccount').textContent = l.thAccount;
    document.getElementById('thOpening').textContent = l.thOpening;
    document.getElementById('thEntry').textContent = l.thEntry;
    document.getElementById('thDebit').textContent = l.thDebit;
    document.getElementById('thCredit').textContent = l.thCredit;
    document.getElementById('thBalance').textContent = l.thBalance;
    document.getElementById('thNotes').textContent = l.thNotes;
    document.getElementById('langSelect').value = lang;
    
    // Re-render period label
    const meta = [];
    if (loadedData.from) meta.push(`${l.from}: ${loadedData.from}`);
    if (loadedData.to) meta.push(`${l.to}: ${loadedData.to}`);
    document.getElementById('meta').textContent = meta.join(' • ');
    
    // Re-render company info
    if (loadedData.company) {
      const name = lang === 'ar' ? (loadedData.company.name_ar || loadedData.company.name_en || '') : (loadedData.company.name_en || loadedData.company.name_ar || '');
      const vat = loadedData.company.vat_number ? `${l.vatNumber}: ${loadedData.company.vat_number}` : '';
      document.getElementById('companyName').textContent = name;
      document.getElementById('companyVat').textContent = vat;
    }
    
    renderTable();
  }
  
  function noteFor(acc, row) {
    const l = labels[currentLang] || labels.ar;
    const code = String(acc.account_code || '');
    const name = String(acc.name || '');
    const rt = String(row.related_type || '');
    const desc = String(row.description || '');
    
    if (code === '1210') {
      if (rt === 'invoice') return l.saleInvoice;
      if (rt === 'payment') return l.cashReceipt;
    }
    if (code === '4130' || code === '4111' || code === '4112' || code === '4121' || code === '4122') return l.salesRevenue;
    if (code === '4190') return l.salesDiscount;
    if (code === '2150') return l.salesTax;
    if (code === '1110' || /cash/i.test(name)) {
      if (rt === 'payment') {
        if (/Salary Payment/i.test(desc)) return l.salaryPayment;
        if (/Payment received/i.test(desc)) return l.cashFromCustomers;
        return l.collection;
      }
    }
    if (code === '5210') return l.salaryExpense;
    if (code === '2430') {
      if (rt === 'payroll_run') return l.payrollLiability;
      if (rt === 'payment') return l.salaryPayment;
    }
    if (code === '5110') return l.purchaseInvoice;
    if (code === '1250') return l.purchaseTax;
    if (code === '2410') return l.supplierLiability;
    
    // Fallback
    if (rt === 'invoice') return l.saleInvoice;
    if (rt === 'supplier_invoice') return l.purchaseInvoice;
    if (rt === 'expense_invoice') return l.expense;
    if (rt === 'payment') return l.paymentCollection;
    if (rt === 'payroll_run') return l.payroll;
    
    return '';
  }
  
  function renderTable() {
    const l = labels[currentLang] || labels.ar;
    const tbody = document.querySelector('#tbl tbody');
    tbody.innerHTML = '';
    
    if (!loadedData.accounts || loadedData.accounts.length === 0) {
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 8;
      td.textContent = l.noData;
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }
    
    for (const acc of loadedData.accounts) {
      const rows = acc.rows || [];
      if (rows.length === 0) continue;
      
      let running = Number(acc.beginning || 0);
      const code = String(acc.account_code || acc.code || acc.account_number || '').trim();
      const name = currentLang === 'ar' 
        ? String(acc.name || acc.name_ar || '').trim()
        : String(acc.name_en || acc.name || '').trim();
      
      rows.forEach((r, idx) => {
        const debit = Number(r.debit || r.debit_total || 0);
        const credit = Number(r.credit || r.credit_total || 0);
        running = running + debit - credit;
        const ref = String(r.description || '').trim() || (String(r.related_type || '') === 'invoice' ? String(r.related_id || '') : '');
        const note = noteFor(acc, r);
        
        const tr = document.createElement('tr');
        const cells = [
          idx === 0 ? (code || '') : '',
          idx === 0 ? (name || '') : '',
          idx === 0 ? fmt(Number(acc.beginning || 0)) : '',
          ref,
          fmt(debit),
          fmt(credit),
          fmt(running),
          note
        ];
        
        cells.forEach((v, i) => {
          const td = document.createElement('td');
          td.textContent = String(v);
          if (i === 4 && Number(debit) > 0) td.className = 'debit';
          if (i === 5 && Number(credit) > 0) td.className = 'credit';
          if (i === 6) td.className = 'balance';
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }
  }
  
  function getApiBase() {
    if (window.__API__) return window.__API__;
    const port = window.location.port;
    if (port === '4000' || port === '3000') return 'http://localhost:5000/api';
    return window.location.origin + '/api';
  }
  const API_BASE = getApiBase();
  function qp(k) { return new URLSearchParams(location.search).get(k); }
  function fmt(n) { try { return Number(n || 0).toFixed(2); } catch { return '0.00'; } }
  function prepareAndPrint() { const bar = document.querySelector('.no-print'); if (bar) bar.style.display = 'none'; window.print(); }
  
  async function authFetch(url) {
    const token = localStorage.getItem('token');
    const h = token ? { Authorization: `Bearer ${token}` } : {};
    const r = await fetch(url, { headers: h });
    if (!r.ok) throw new Error('request_failed');
    return r.json();
  }
  
  async function load() {
    document.getElementById('langSelect').value = currentLang;
    if (currentLang === 'en') {
      document.documentElement.lang = 'en';
      document.body.className = 'ltr';
    }
    
    try { loadedData.company = await authFetch(`${API_BASE}/settings/settings_company`); } catch {}
    try { loadedData.branding = await authFetch(`${API_BASE}/settings/settings_branding`); } catch {}
    
    if (loadedData.branding && loadedData.branding.logo) {
      const img = document.getElementById('logo');
      img.src = loadedData.branding.logo;
      img.style.display = 'block';
    }
    
    loadedData.from = qp('from');
    loadedData.to = qp('to');
    
    const paramsTB = new URLSearchParams();
    if (loadedData.from) paramsTB.set('from', loadedData.from);
    if (loadedData.to) paramsTB.set('to', loadedData.to);
    
    const tb = await authFetch(`${API_BASE}/reports/trial-balance${paramsTB.toString() ? `?${paramsTB.toString()}` : ''}`);
    const accounts = Array.isArray(tb?.items) ? tb.items : [];
    
    // Fetch account names
    const accountMap = new Map();
    try {
      const accountsTree = await authFetch(`${API_BASE}/accounts`);
      function flattenAccounts(arr) {
        if (!Array.isArray(arr)) return;
        for (const a of arr) {
          if (a && a.id) {
            accountMap.set(Number(a.id), a);
            if (a.account_code) accountMap.set(String(a.account_code), a);
            if (a.account_number) accountMap.set(String(a.account_number), a);
            if (Array.isArray(a.children)) flattenAccounts(a.children);
          }
        }
      }
      flattenAccounts(accountsTree);
    } catch {}
    
    // Fetch drilldown for each account
    loadedData.accounts = [];
    for (const acc of accounts) {
      const accId = Number(acc.account_id || acc.id || 0);
      const accCode = String(acc.account_code || acc.code || acc.account_number || '').trim();
      
      // Enrich with account names
      const fullAcc = accountMap.get(accId) || accountMap.get(accCode) || {};
      acc.name = acc.name || fullAcc.name || '';
      acc.name_en = acc.name_en || fullAcc.name_en || '';
      acc.name_ar = acc.name_ar || fullAcc.name || '';
      
      const paramsDL = new URLSearchParams();
      if (loadedData.from) paramsDL.set('from', loadedData.from);
      if (loadedData.to) paramsDL.set('to', loadedData.to);
      paramsDL.set('account_id', String(accId));
      
      try {
        const drill = await authFetch(`${API_BASE}/reports/trial-balance/drilldown${paramsDL.toString() ? `?${paramsDL.toString()}` : ''}`);
        acc.rows = Array.isArray(drill?.items) ? drill.items : [];
      } catch {
        acc.rows = [];
      }
      
      if (acc.rows.length > 0) {
        loadedData.accounts.push(acc);
      }
    }
    
    changeLang(currentLang);
    setTimeout(() => window.print(), 200);
  }
  
  load().catch(() => { alert('فشل الطباعة. يرجى المحاولة مرة أخرى.'); });
</script>
</body>
</html>
