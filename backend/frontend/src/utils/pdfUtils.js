
export { createPdf, createPdf as createPDF } from '../printing/pdf/pdfEngine'
export async function ensureImageDataUrl(src){ const s=String(src||'').trim(); if(/^data:image\/(png|jpe?g);base64,/i.test(s)) return s; const isB64=/^[A-Za-z0-9+/=]+$/.test(s); if(isB64&&s.startsWith('iVBOR')) return `data:image/png;base64,${s}`; if(isB64&&s.startsWith('/9j/')) return `data:image/jpeg;base64,${s}`; async function viaCanvas(u){ return await new Promise(resolve=>{ try{ const img=new Image(); img.crossOrigin='anonymous'; img.onload=()=>{ try{ const c=document.createElement('canvas'); c.width=img.width; c.height=img.height; const g=c.getContext('2d'); g.drawImage(img,0,0); const out=c.toDataURL('image/png'); resolve(/^data:image\/(png|jpe?g);base64,/i.test(String(out))?String(out):null) }catch{ resolve(null) } }; img.onerror=()=>resolve(null); img.src=String(u) }catch{ resolve(null) } }) }
  let u=s; if(/^\//.test(s) && typeof window!=='undefined'){ u=String(window.location?.origin||'')+s }
  if(/^https?:\/\//i.test(u)||/^blob:/i.test(u)){ try{ const res=await fetch(u,{ mode:'cors' }); if(!res.ok){ const cv=await viaCanvas(u); return cv||null } const blob=await res.blob(); if(/^image\/(png|jpe?g)$/i.test(String(blob.type||''))){ const dataUrl=await new Promise((resolve,reject)=>{ const r=new FileReader(); r.onloadend=()=>resolve(r.result); r.onerror=reject; r.readAsDataURL(blob) }); return /^data:image\/(png|jpe?g);base64,/i.test(String(dataUrl))?String(dataUrl):null } else { const cv=await viaCanvas(u); return cv||null } }catch{ const cv=await viaCanvas(u); return cv||null } } return null }
export function normalizeImage(img, opts){ const o=opts||{}; const w=o.width!=null?o.width:80; const h=o.height!=null?o.height:40; const al=o.alignment||'right'; const m=o.margin||[0,0,0,8]; const s=String(img||''); if(/^data:image\//.test(s)) return { image:s, width:w, height:h, alignment:al, margin:m }; return null }
export function validatePdfDefinition(doc){ const errors=[]; function isValidImage(img){ return (typeof img==='string' && img.startsWith('data:image/') && img.includes(';base64,')) } function walk(node, path='doc'){ if(node===undefined){ errors.push(`❌ ${path} is undefined`); return } if(node===null) return; if(node.image!==undefined){ if(!isValidImage(node.image)){ errors.push(`❌ Invalid image at ${path}.image → value: ${String(node.image).slice(0,60)}`) } } if(node.table){ if(!Array.isArray(node.table.body)){ errors.push(`❌ Table body is invalid at ${path}.table.body`) } else { node.table.body.forEach((row,r)=>{ if(!Array.isArray(row)){ errors.push(`❌ Table row ${r} is not array at ${path}`) } }) } } if(node.margin){ if(!Array.isArray(node.margin) || node.margin.length!==4 || node.margin.some(m=>typeof m!=='number')){ errors.push(`❌ Invalid margin at ${path}`) } } if(Array.isArray(node)){ node.forEach((child,i)=>walk(child, `${path}[${i}]`)) } else if(typeof node==='object'){ Object.keys(node).forEach(key=>{ if(key!=='image'){ walk(node[key], `${path}.${key}`) } }) } } walk(doc); return errors }