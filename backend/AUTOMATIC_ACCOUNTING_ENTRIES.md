# ุงููููุฏ ุงููุญุงุณุจูุฉ ุงูุชููุงุฆูุฉ - ุชู ุงูุชุทุจูู โ

## ๐ ุงูููุงู ุงููุทููุจุฉ

### 1. ูููุฏ ูุญุงุณุจูุฉ ุชููุงุฆูุฉ ูููุดุชุฑูุงุช โ

**ุงููุดููุฉ:**
- โ ูุง ุชูุฌุฏ ุขููุฉ ุชููุงุฆูุฉ ูุฅูุดุงุก ูููุฏ ูุญุงุณุจูุฉ ุนูุฏ ุชุณุฌูู ุงููุดุชุฑูุงุช

**ุงูุญู:**
- โ ุฅุถุงูุฉ ุฏุงูุฉ `createSupplierInvoiceJournalEntry` ูุฅูุดุงุก ุงููููุฏ ุงููุญุงุณุจูุฉ
- โ ุชุญุฏูุซ `handlePostSupplierInvoice` ูุงุณุชุฏุนุงุก ุงูุฏุงูุฉ ุนูุฏ ูุดุฑ ุงููุงุชูุฑุฉ

**ุงูุญุณุงุจุงุช ุงููุณุชุฎุฏูุฉ:**
- **ูุฏูู:** 
  - `5210` - ูุดุชุฑูุงุช (ุงููุจูุบ ุจุฏูู ุถุฑูุจุฉ)
  - `1170` - ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ ุงููุงุจูุฉ ููุงุณุชุฑุฏุงุฏ (ุฅุฐุง ูุงูุช ุงูุถุฑูุจุฉ > 0)
- **ุฏุงุฆู:**
  - ุญุณุงุจ ุงูููุฑุฏ (ุญุณุงุจ ูุฑุนู ุชุญุช `2111`) - ุฅุฐุง ูุงูุช ุงูุดุฑุงุก ุขุฌู
  - ุญุณุงุจ ุงูููุฏ/ุงูุจูู (`1111` ุฃู `payment_account_code`) - ุฅุฐุง ูุงูุช ุงูุดุฑุงุก ููุฏู

**ุงูููุฏ:**
```javascript
async function createSupplierInvoiceJournalEntry(
  invoiceId, supplierId, subtotal, discount, tax, total, 
  paymentMethod, paymentAccountCode, lines, branch, client = null
)
```

---

### 2. ุชุณุฌูู COGS (ุชูููุฉ ุงููุจูุนุงุช) โ

**ุงููุดููุฉ:**
- โ ูุง ุชูุฌุฏ ุขููุฉ ูุชุณุฌูู ุชูููุฉ ุงููุจูุนุงุช ุนูุฏ ุจูุน ุงูุจุถุงุนุฉ

**ุงูุญู:**
- โ ุชุญุฏูุซ `createInvoiceJournalEntry` ูุญุณุงุจ ูุชุณุฌูู COGS ุชููุงุฆูุงู
- โ ุญุณุงุจ ุชูููุฉ ุงูููุชุฌุงุช ูู ุฌุฏูู `products` (ุญูู `cost`)
- โ ุฅูุดุงุก ููุฏ ูุญุงุณุจู: ูุฏูู `5110` (ุชูููุฉ ุงููุจูุนุงุช)ุ ุฏุงุฆู `1130` (ุงููุฎุฒูู)

**ุงูุญุณุงุจุงุช ุงููุณุชุฎุฏูุฉ:**
- **ูุฏูู:** `5110` - ุชูููุฉ ุงููุจูุนุงุช
- **ุฏุงุฆู:** `1130` - ุงููุฎุฒูู

**ุงูููุฏ:**
```javascript
// ูู createInvoiceJournalEntry:
if (invoiceLines && Array.isArray(invoiceLines) && invoiceLines.length > 0) {
  // ุญุณุงุจ COGS ูู cost ร qty ููู ููุชุฌ
  // ุฅูุดุงุก ููุฏ: ูุฏูู 5110ุ ุฏุงุฆู 1130
}
```

---

## ๐ง ุงูุชุบููุฑุงุช ูู ุงููููุงุช

### `backend/server.js`

#### 1. ุฏุงูุฉ ุฌุฏูุฏุฉ: `createSupplierInvoiceJournalEntry` (ุงูุณุทูุฑ 5130-5200)

```javascript
async function createSupplierInvoiceJournalEntry(
  invoiceId, supplierId, subtotal, discount, tax, total, 
  paymentMethod, paymentAccountCode, lines, branch, client = null
) {
  // ุฅูุดุงุก ููุฏ ูุญุงุณุจู ูููุดุชุฑูุงุช
  // - ูุฏูู: 5210 (ูุดุชุฑูุงุช), 1170 (VAT Input)
  // - ุฏุงุฆู: ุญุณุงุจ ุงูููุฑุฏ (2111) ุฃู ุงูููุฏ/ุงูุจูู (1111)
}
```

#### 2. ุชุญุฏูุซ `handlePostSupplierInvoice` (ุงูุณุทูุฑ 4432-4500)

- โ ุฅุถุงูุฉ transaction management (`BEGIN`/`COMMIT`/`ROLLBACK`)
- โ ุงุณุชุฏุนุงุก `createSupplierInvoiceJournalEntry` ุนูุฏ ูุดุฑ ุงููุงุชูุฑุฉ
- โ ูุนุงูุฌุฉ `lines` ูู JSONB/JSON string

#### 3. ุชุญุฏูุซ `createInvoiceJournalEntry` (ุงูุณุทูุฑ 5223-5373)

- โ ุฅุถุงูุฉ ูุนุงูู `invoiceLines` ูู ุงูุชูููุน
- โ ุญุณุงุจ COGS ูู `cost ร qty` ููู ููุชุฌ
- โ ุฅุถุงูุฉ ููุฏ: ูุฏูู `5110`ุ ุฏุงุฆู `1130`

#### 4. ุชุญุฏูุซ ุงุณุชุฏุนุงุก `createInvoiceJournalEntry` (ุงูุณุทุฑ 5815)

- โ ุฅุฑุณุงู `linesArray` ููุญุณุงุจ COGS

---

## ๐ ูุซุงู ุนูู ุงููููุฏ ุงููุญุงุณุจูุฉ

### ูุซุงู 1: ูุงุชูุฑุฉ ูุดุชุฑูุงุช ููุฏูุฉ

```
ูุงุชูุฑุฉ ูุดุชุฑูุงุช #123
ุงููุจูุบ: 1000 ุฑูุงู + 150 ุฑูุงู ุถุฑูุจุฉ = 1150 ุฑูุงู

ุงูููุฏ:
ูุฏูู:
  - 5210 (ูุดุชุฑูุงุช): 1000
  - 1170 (VAT Input): 150
ุฏุงุฆู:
  - 1111 (ุตูุฏูู ุฑุฆูุณู): 1150
```

### ูุซุงู 2: ูุงุชูุฑุฉ ูุดุชุฑูุงุช ุขุฌูุฉ

```
ูุงุชูุฑุฉ ูุดุชุฑูุงุช #124
ุงููุจูุบ: 2000 ุฑูุงู + 300 ุฑูุงู ุถุฑูุจุฉ = 2300 ุฑูุงู
ุงูููุฑุฏ: ุงูููุฑุฏ XYZ

ุงูููุฏ:
ูุฏูู:
  - 5210 (ูุดุชุฑูุงุช): 2000
  - 1170 (VAT Input): 300
ุฏุงุฆู:
  - 2111/XYZ (ุญุณุงุจ ุงูููุฑุฏ): 2300
```

### ูุซุงู 3: ูุงุชูุฑุฉ ูุจูุนุงุช ูุน COGS

```
ูุงุชูุฑุฉ ูุจูุนุงุช #456
ุงููุจูุบ: 1000 ุฑูุงู + 150 ุฑูุงู ุถุฑูุจุฉ = 1150 ุฑูุงู
ุงูููุชุฌุงุช:
  - ููุชุฌ A: 5 ูุญุฏุงุช ร 100 ุฑูุงู = 500 ุฑูุงู (ุชูููุฉ: 60 ุฑูุงู/ูุญุฏุฉ)
  - ููุชุฌ B: 3 ูุญุฏุงุช ร 200 ุฑูุงู = 600 ุฑูุงู (ุชูููุฉ: 120 ุฑูุงู/ูุญุฏุฉ)

ุงูููุฏ:
ูุฏูู:
  - 1111 (ุตูุฏูู ุฑุฆูุณู): 1150
  - 5110 (ุชูููุฉ ุงููุจูุนุงุช): 660 (5ร60 + 3ร120)
ุฏุงุฆู:
  - 4111 (ูุจูุนุงุช ููุฏูุฉ - China Town): 1000
  - 2141 (VAT Output): 150
  - 1130 (ุงููุฎุฒูู): 660
```

---

## โ ุงูุชุญูู ูู ุงูุชุทุจูู

### ูููุดุชุฑูุงุช:
1. โ ุฅูุดุงุก ูุงุชูุฑุฉ ููุฑุฏ ุฌุฏูุฏุฉ
2. โ ูุดุฑ ุงููุงุชูุฑุฉ (`POST /api/supplier-invoices/:id/post`)
3. โ ุงูุชุญูู ูู ุฅูุดุงุก ููุฏ ูุญุงุณุจู ุชููุงุฆู ูู `journal_entries`
4. โ ุงูุชุญูู ูู ุฑุจุท ุงูููุฏ ุจุงูุญุณุงุจุงุช ุงูุตุญูุญุฉ:
   - `5210` (ูุดุชุฑูุงุช)
   - `1170` (VAT Input)
   - ุญุณุงุจ ุงูููุฑุฏ (ุญุณุงุจ ูุฑุนู ุชุญุช `2111`) ุฃู ุงูููุฏ/ุงูุจูู

### ูููุจูุนุงุช (COGS):
1. โ ุฅุตุฏุงุฑ ูุงุชูุฑุฉ ูุจูุนุงุช ูู POS
2. โ ุงูุชุญูู ูู ุฅูุดุงุก ููุฏ ูุญุงุณุจู ุชููุงุฆู
3. โ ุงูุชุญูู ูู ุญุณุงุจ COGS:
   - ูุฏูู: `5110` (ุชูููุฉ ุงููุจูุนุงุช)
   - ุฏุงุฆู: `1130` (ุงููุฎุฒูู)
4. โ ุงูุชุญูู ูู ุฃู COGS = sum(cost ร qty) ููู ููุชุฌ

---

## ๐ ููุงุญุธุงุช ูููุฉ

1. **COGS ูุนุชูุฏ ุนูู `cost` ูู ุฌุฏูู `products`:**
   - ูุฌุจ ุงูุชุฃูุฏ ูู ุฃู ุฌููุน ุงูููุชุฌุงุช ูุฏููุง `cost` ุตุญูุญ
   - ุฅุฐุง ูู ููู `cost` ููุฌูุฏุงูุ ูุชู ุงุนุชุจุงุฑ COGS = 0

2. **ุงููุดุชุฑูุงุช:**
   - ุงูููุฏ ุงููุญุงุณุจู ูููุดุฃ ููุท ุนูุฏ ูุดุฑ ุงููุงุชูุฑุฉ (`status = 'posted'`)
   - ุฅุฐุง ูุงูุช ุงููุงุชูุฑุฉ ููุฏูุฉุ ููุณุชุฎุฏู `payment_account_code` ุฃู `1111` (ุงูุชุฑุงุถู)
   - ุฅุฐุง ูุงูุช ุงููุงุชูุฑุฉ ุขุฌูุฉุ ููุณุชุฎุฏู ุญุณุงุจ ุงูููุฑุฏ (ุญุณุงุจ ูุฑุนู ุชุญุช `2111`)

3. **ุงููุจูุนุงุช:**
   - COGS ููุญุณุจ ุชููุงุฆูุงู ูู `lines` ุฅุฐุง ุชู ุชูุฑูุฑูุง
   - ุฅุฐุง ูู ูุชู ุชูุฑูุฑ `lines`ุ ูู ูุชู ุญุณุงุจ COGS (ูู ูุคุซุฑ ุนูู ุงูููุฏ)

---

## ๐ฏ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ

โ **ุฌููุน ุงูููุงู ุงููุทููุจุฉ ุชู ุชุทุจูููุง ุจูุฌุงุญ!**

- โ ูููุฏ ูุญุงุณุจูุฉ ุชููุงุฆูุฉ ูููุดุชุฑูุงุช
- โ ุชุณุฌูู COGS ุชููุงุฆู ูููุจูุนุงุช
- โ ุฑุจุท ุตุญูุญ ุจุงูุญุณุงุจุงุช ูู ุดุฌุฑุฉ ุงูุญุณุงุจุงุช

**ุชุงุฑูุฎ ุงูุชุทุจูู:** 2025-01-XX  
**ุงูุญุงูุฉ:** โ ุชู ุงูุชุทุจูู ุจูุฌุงุญ